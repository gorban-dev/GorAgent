# GorAgent

Одностраничный веб-чат с ИИ-агентом на базе OpenAI API.

---

## 🛠 Стек технологий

### Backend

| Технология | Версия | Описание |
|------------|--------|----------|
| **Node.js** | 18+ | Серверная среда выполнения JavaScript |
| **Express.js** | 4.18.2 | Минималистичный веб-фреймворк |
| **dotenv** | 16.3.1 | Загрузка переменных окружения из `.env` |
| **cors** | 2.8.5 | Middleware для обработки CORS-запросов |
| **Fetch API** | built-in | Нативные HTTP-запросы к OpenAI API |

### Frontend

| Технология | Описание |
|------------|----------|
| **HTML5** | Семантическая разметка страницы |
| **CSS3** | CSS Variables, Flexbox, анимации, адаптивная вёрстка |
| **Vanilla JavaScript** | Логика приложения без фреймворков |
| **Google Fonts** | Шрифты Outfit и JetBrains Mono |
| **LocalStorage API** | Сохранение истории чата в браузере |

### AI & API

| Технология | Описание |
|------------|----------|
| **OpenAI API** | Chat Completions API для работы с GPT-моделями |
| **gpt-4.1-mini** | Модель по умолчанию (настраивается в `.env`) |

### Ключевые особенности реализации

- 🔄 **Retry-логика** — автоматические повторные запросы при ошибках 429 (rate limit) с экспоненциальной задержкой
- 📝 **Markdown-форматирование** — поддержка кода, жирного текста, курсива, ссылок
- 💾 **Персистентность** — история чата сохраняется в `localStorage`
- 📱 **Адаптивный дизайн** — mobile-first подход, корректное отображение на всех устройствах
- 🌙 **Тёмная тема** — стильный интерфейс с неоновыми акцентами и градиентами
- ⚡ **Без сборщиков** — проект работает без webpack/vite, просто запустите `npm start`
- 🗜️ **Сжатие истории** — автоматическое создание резюме длинных диалогов для экономии токенов
- 🔔 **Система напоминаний** — создание напоминаний через чат с интеграцией MCP для реальных данных

---

## 🗜️ Механизм сжатия истории диалога

### Что это такое?

Механизм сжатия истории позволяет автоматически создавать краткое резюме диалога каждые N сообщений. Это решает несколько проблем:

1. **Экономия токенов** — вместо отправки всей истории в API, отправляется сжатое резюме
2. **Обход лимитов контекста** — даже долгие диалоги помещаются в контекстное окно модели
3. **Сохранение контекста** — важная информация из разговора не теряется

### Как это работает?

```
┌─────────────────────────────────────────────────────────────┐
│                    ДИАЛОГ (10 сообщений)                    │
├─────────────────────────────────────────────────────────────┤
│ User: Привет! Меня зовут Алекс.                             │
│ Agent: Здравствуйте, Алекс! Чем могу помочь?                │
│ User: Хочу средний по крепости кальян                       │
│ Agent: Какие вкусы предпочитаете?                           │
│ User: Люблю фрукты и мяту                                   │
│ Agent: Моно-вкус или микс?                                  │
│ User: Микс, пожалуйста                                      │
│ Agent: Есть ли вкусы, которые не любите?                    │
│ User: Не люблю виноград                                     │
│ Agent: Какое у вас настроение сегодня?                      │
└─────────────────────────────────────────────────────────────┘
                              │
                              ▼ СЖАТИЕ (достигнут порог 10)
┌─────────────────────────────────────────────────────────────┐
│                         РЕЗЮМЕ                              │
├─────────────────────────────────────────────────────────────┤
│ ### Резюме диалога                                          │
│ **Пользователь сообщил:**                                   │
│ - Имя: Алекс                                                │
│ - Крепость: средняя                                         │
│ - Вкусы: фрукты, мята                                       │
│ - Предпочтение: микс                                        │
│ - Не любит: виноград                                        │
│                                                             │
│ **Обсуждалось:**                                            │
│ - Подбор кальяна по предпочтениям                           │
│                                                             │
│ **Важный контекст:**                                        │
│ - Осталось выяснить настроение для финальной рекомендации   │
└─────────────────────────────────────────────────────────────┘
                              │
                              ▼
           Продолжение диалога с сохранённым контекстом
```

### Сравнение использования токенов

| Параметр | Без сжатия | Со сжатием | Экономия |
|----------|------------|------------|----------|
| 10 сообщений | ~800 токенов | ~200 токенов | **75%** |
| 20 сообщений | ~1600 токенов | ~350 токенов | **78%** |
| 50 сообщений | ~4000 токенов | ~500 токенов | **87%** |

### Настройка

1. Откройте настройки (⚙️)
2. Найдите секцию "🗜️ Сжатие истории диалога"
3. Включите переключатель
4. Установите порог (по умолчанию 10 сообщений)

### API эндпоинты

```javascript
// Ручное сжатие истории
POST /api/compress-history
Body: { history: [...], provider: 'openai'|'openrouter', model?: string }

// Получение статистики сжатия
GET /api/compression-stats
```

### Проверка работы из консоли браузера

```javascript
// Посмотреть текущую статистику
console.log(compressionStats);

// Ручное сжатие
await compressHistory(true);

// Проверить резюме
console.log(compressionSummary);
```

---

## 🔔 Система напоминаний

### Что это такое?

Система напоминаний позволяет создавать автоматические уведомления о важных событиях, погоде, новостях и других темах. Напоминания могут работать в фоновом режиме и отправлять уведомления в чат в заданное время.

### Ключевые возможности

- **Создание через чат** — просто напишите сообщение типа "Напоминай мне о погоде в Шерегеше каждое утро"
- **MCP интеграция** — для погодных напоминаний используются реальные данные через MCP сервер
- **Гибкие интервалы** — каждую минуту, каждые 15/30 минут, ежечасно, ежедневно
- **Автоматическая генерация** — AI создаёт персонализированные уведомления
- **Хранение в localStorage** — напоминания сохраняются между сессиями

### Как использовать?

#### Через чат (рекомендуемый способ)

Просто напишите сообщение агенту:

```
Напоминай мне о погоде в Шерегеше каждое утро
Напомни о встрече каждый час
Создай напоминание о новостях каждые 30 минут
```

#### Через интерфейс настроек

1. Откройте настройки (⚙️)
2. Найдите секцию "🔔 Напоминания"
3. Заполните форму создания напоминания
4. Нажмите "➕ Создать"

### Примеры запросов

| Запрос | Результат |
|--------|-----------|
| `Напоминай о погоде в Москве каждую минуту` | Уведомления о погоде в Москве каждую минуту |
| `напомни о встрече каждый час` | Уведомления о встрече каждый час |
| `Создай напоминание о новостях каждые 30 минут` | Технологические новости каждые 30 минут |
| `напоминай о спорте ежедневно` | Ежедневные уведомления о спорте |

### Как это работает?

```
┌─────────────────────────────────────────────────────────────┐
│                    ЗАПРОС ПОЛЬЗОВАТЕЛЯ                      │
├─────────────────────────────────────────────────────────────┤
│ User: Напоминай мне о погоде в Шерегеше каждое утро         │
└─────────────────────────────────────────────────────────────┘
                              │
                              ▼ РАСПОЗНАВАНИЕ
┌─────────────────────────────────────────────────────────────┤
│ Название: Погода в Шерегеше                                 │
│ Описание: погода в Шерегеше                                 │
│ Интервал: daily                                            │
└─────────────────────────────────────────────────────────────┘
                              │
                              ▼ СОЗДАНИЕ НАПОМИНАНИЯ
┌─────────────────────────────────────────────────────────────┤
│ ID: reminder_123456789                                      │
│ Следующее срабатывание: завтра 09:00                        │
└─────────────────────────────────────────────────────────────┘
                              │
                              ▼ СРАБАТЫВАНИЕ (завтра 09:00)
┌─────────────────────────────────────────────────────────────┤
│ 🔍 ЗАПРОС К MCP СЕРВЕРУ                                     │
│ get_weather(location: "Шерегеш")                            │
├─────────────────────────────────────────────────────────────┤
│ 📊 РЕАЛЬНЫЕ ДАННЫЕ ПОГОДЫ                                   │
│ Температура: +15°C                                          │
│ Осадки: нет                                                 │
│ Ветер: 3 м/с                                                │
└─────────────────────────────────────────────────────────────┘
                              │
                              ▼ ГЕНЕРАЦИЯ УВЕДОМЛЕНИЯ
┌─────────────────────────────────────────────────────────────┤
│ 🤖 ЗАПРОС К AI                                              │
│ "Создай уведомление о погоде на основе данных..."          │
├─────────────────────────────────────────────────────────────┤
│ 📨 УВЕДОМЛЕНИЕ В ЧАТ                                        │
│ 🔔 Погода в Шерегеше                                        │
│ ☀️ Сегодня солнечно, температура +15°C, слабый ветер...    │
└─────────────────────────────────────────────────────────────┘
```

### MCP интеграция для погоды

Для погодных напоминаний система пытается получить реальные данные через MCP инструменты:

1. Автоматическое распознавание запросов о погоде
2. Извлечение названия локации из текста
3. Вызов MCP инструмента `get_weather`, `weather` или аналогичного
4. Использование реальных данных в генерации уведомления

### API эндпоинты

```javascript
// Выполнение MCP инструмента
POST /api/mcp/execute
Body: { toolName: "get_weather", arguments: { location: "Шерегеш" } }

// Получение списка MCP инструментов
GET /api/mcp/tools
```

### Проверка работы из консоли браузера

```javascript
// Посмотреть активные напоминания
console.log(getActiveReminders());

// Создать тестовое напоминание
createReminder("Тест", "Тестовое напоминание", "hourly");

// Распознать запрос
console.log(parseReminderRequest("Напоминай о погоде в Москве"));

// Проверить напоминания немедленно (для тестирования)
checkRemindersNow();

// Показать отладочную информацию
showReminderDebug();

// Тестировать получение погоды
testMCPWeather('Шерегеш');

// Тестировать MCP инструмент напрямую
testMCPTool('get_weather', { city: 'Шерегеш' });

// Специальный тест для вашего MCP сервера
testWeatherCity('Bratsk');

// Тест извлечения города из текста
testCityExtraction('Напоминай о погоде в Шерегеше');

// Удалить все напоминания
clearAllReminders();

// Полная остановка всех процессов напоминаний
stopAllReminders();

// Принудительная очистка всех данных (включая localStorage)
forceClearAllReminderData();

// Проверка содержимого localStorage
inspectReminderStorage();

// Полное сканирование localStorage
scanAllLocalStorage();

// ПОЛНОЕ УНИЧТОЖЕНИЕ всех данных напоминаний (опасно!)
nukeAllReminders();

// Принудительное обновление UI напоминаний
forceUpdateRemindersUI();

// Создание тестового напоминания с проверкой UI
testCreateReminderUI('Тест', 'every-15-min');
```

### Отладка проблем

Если напоминания не приходят, проверьте:

1. **Консоль браузера** - откройте DevTools (F12) и посмотрите на сообщения
2. **Активные напоминания** - выполните `showReminderDebug()` в консоли
3. **Ручная проверка** - нажмите кнопку "🧪 Проверить сейчас" в настройках
4. **Интервал проверки** - система проверяет каждые 10 секунд

### Возможные проблемы и решения

| Проблема | Решение |
|----------|---------|
| Напоминания не приходят | Проверьте консоль, нажмите "🧪 Проверить сейчас" |
| Минутные напоминания не работают | Подтвердите создание, подождите 10-20 секунд |
| Ошибки в консоли | Проверьте подключение к MCP серверу (если используется погода) |
| Напоминания не сохраняются | Очистите localStorage или проверьте права браузера |
| MCP: "City parameter is required" | Система автоматически попробует разные параметры (city, location, query, place, name) |
| Погода не отображается в уведомлениях | Проверьте работу MCP сервера командой `testMCPWeather('город')` |
| Не вижу все напоминания | Обновите интерфейс или используйте `showReminderDebug()` |
| Хочу удалить все напоминания | Используйте кнопку "🗑️ Удалить все" или `clearAllReminders()` |
| Сервер продолжает запрашивать погоду без напоминаний | Используйте `stopAllReminders()` для полной остановки всех процессов |
| Есть напоминания в localStorage, но не видны в интерфейсе | Используйте `inspectReminderStorage()` для проверки, затем `forceClearAllReminderData()` |
| Есть старые/скрытые напоминания под другими ключами | Используйте `scanAllLocalStorage()` для поиска, затем `nukeAllReminders()` для полного удаления |
| Напоминания не отображаются в интерфейсе | Используйте `forceUpdateRemindersUI()` для принудительного обновления или `testCreateReminderUI()` для тестирования |