# GorAgent

Одностраничный веб-чат с ИИ-агентом на базе OpenAI API.

> **🆕 Новое:** [MCP Multi-Server](./START-MCP-MULTI.md) - архитектура с несколькими независимыми MCP серверами (Weather → Formatter → FileSaver)  
> **📦 Также доступно:** [MCP Chain Agent](./QUICKSTART-MCP.md) - одиночный MCP сервер с цепочкой tools

---

## 🛠 Стек технологий

### Backend

| Технология | Версия | Описание |
|------------|--------|----------|
| **Node.js** | 18+ | Серверная среда выполнения JavaScript |
| **Express.js** | 4.18.2 | Минималистичный веб-фреймворк |
| **dotenv** | 16.3.1 | Загрузка переменных окружения из `.env` |
| **cors** | 2.8.5 | Middleware для обработки CORS-запросов |
| **Fetch API** | built-in | Нативные HTTP-запросы к OpenAI API |

### Frontend

| Технология | Описание |
|------------|----------|
| **HTML5** | Семантическая разметка страницы |
| **CSS3** | CSS Variables, Flexbox, анимации, адаптивная вёрстка |
| **Vanilla JavaScript** | Логика приложения без фреймворков |
| **Google Fonts** | Шрифты Outfit и JetBrains Mono |
| **LocalStorage API** | Сохранение истории чата в браузере |

### AI & API

| Технология | Описание |
|------------|----------|
| **OpenAI API** | Chat Completions API для работы с GPT-моделями |
| **gpt-4.1-mini** | Модель по умолчанию (настраивается в `.env`) |

### Ключевые особенности реализации

- 🔄 **Retry-логика** — автоматические повторные запросы при ошибках 429 (rate limit) с экспоненциальной задержкой
- 📝 **Markdown-форматирование** — поддержка кода, жирного текста, курсива, ссылок
- 💾 **Персистентность** — история чата сохраняется в `localStorage`
- 📱 **Адаптивный дизайн** — mobile-first подход, корректное отображение на всех устройствах
- 🌙 **Тёмная тема** — стильный интерфейс с неоновыми акцентами и градиентами
- ⚡ **Без сборщиков** — проект работает без webpack/vite, просто запустите `npm start`
- 🗜️ **Сжатие истории** — автоматическое создание резюме длинных диалогов для экономии токенов
- 🔔 **Система напоминаний** — создание напоминаний через чат с интеграцией MCP для реальных данных
- 🔗 **MCP Chain Agent** — агент-оркестратор для координации цепочек MCP инструментов (поиск → суммаризация → сохранение)

---

## 🗜️ Механизм сжатия истории диалога

### Что это такое?

Механизм сжатия истории позволяет автоматически создавать краткое резюме диалога каждые N сообщений. Это решает несколько проблем:

1. **Экономия токенов** — вместо отправки всей истории в API, отправляется сжатое резюме
2. **Обход лимитов контекста** — даже долгие диалоги помещаются в контекстное окно модели
3. **Сохранение контекста** — важная информация из разговора не теряется

### Как это работает?

```
┌─────────────────────────────────────────────────────────────┐
│                    ДИАЛОГ (10 сообщений)                    │
├─────────────────────────────────────────────────────────────┤
│ User: Привет! Меня зовут Алекс.                             │
│ Agent: Здравствуйте, Алекс! Чем могу помочь?                │
│ User: Хочу средний по крепости кальян                       │
│ Agent: Какие вкусы предпочитаете?                           │
│ User: Люблю фрукты и мяту                                   │
│ Agent: Моно-вкус или микс?                                  │
│ User: Микс, пожалуйста                                      │
│ Agent: Есть ли вкусы, которые не любите?                    │
│ User: Не люблю виноград                                     │
│ Agent: Какое у вас настроение сегодня?                      │
└─────────────────────────────────────────────────────────────┘
                              │
                              ▼ СЖАТИЕ (достигнут порог 10)
┌─────────────────────────────────────────────────────────────┐
│                         РЕЗЮМЕ                              │
├─────────────────────────────────────────────────────────────┤
│ ### Резюме диалога                                          │
│ **Пользователь сообщил:**                                   │
│ - Имя: Алекс                                                │
│ - Крепость: средняя                                         │
│ - Вкусы: фрукты, мята                                       │
│ - Предпочтение: микс                                        │
│ - Не любит: виноград                                        │
│                                                             │
│ **Обсуждалось:**                                            │
│ - Подбор кальяна по предпочтениям                           │
│                                                             │
│ **Важный контекст:**                                        │
│ - Осталось выяснить настроение для финальной рекомендации   │
└─────────────────────────────────────────────────────────────┘
                              │
                              ▼
           Продолжение диалога с сохранённым контекстом
```

### Сравнение использования токенов

| Параметр | Без сжатия | Со сжатием | Экономия |
|----------|------------|------------|----------|
| 10 сообщений | ~800 токенов | ~200 токенов | **75%** |
| 20 сообщений | ~1600 токенов | ~350 токенов | **78%** |
| 50 сообщений | ~4000 токенов | ~500 токенов | **87%** |

### Настройка

1. Откройте настройки (⚙️)
2. Найдите секцию "🗜️ Сжатие истории диалога"
3. Включите переключатель
4. Установите порог (по умолчанию 10 сообщений)

### API эндпоинты

```javascript
// Ручное сжатие истории
POST /api/compress-history
Body: { history: [...], provider: 'openai'|'openrouter', model?: string }

// Получение статистики сжатия
GET /api/compression-stats
```

### Проверка работы из консоли браузера

```javascript
// Посмотреть текущую статистику
console.log(compressionStats);

// Ручное сжатие
await compressHistory(true);

// Проверить резюме
console.log(compressionSummary);
```

---

## 🔔 Система напоминаний

### Что это такое?

Система напоминаний позволяет создавать автоматические уведомления о важных событиях, погоде, новостях и других темах. Напоминания могут работать в фоновом режиме и отправлять уведомления в чат в заданное время.

### Ключевые возможности

- **Создание через чат** — просто напишите сообщение типа "Напоминай мне о погоде в Шерегеше каждое утро"
- **MCP интеграция** — для погодных напоминаний используются реальные данные через MCP сервер
- **Гибкие интервалы** — каждую минуту, каждые 15/30 минут, ежечасно, ежедневно
- **Автоматическая генерация** — AI создаёт персонализированные уведомления
- **Хранение в localStorage** — напоминания сохраняются между сессиями

### Как использовать?

#### Через чат (рекомендуемый способ)

Просто напишите сообщение агенту:

```
Напоминай мне о погоде в Шерегеше каждое утро
Напомни о встрече каждый час
Создай напоминание о новостях каждые 30 минут
```

#### Через интерфейс настроек

1. Откройте настройки (⚙️)
2. Найдите секцию "🔔 Напоминания"
3. Заполните форму создания напоминания
4. Нажмите "➕ Создать"

### Примеры запросов

| Запрос | Результат |
|--------|-----------|
| `Напоминай о погоде в Москве каждую минуту` | Уведомления о погоде в Москве каждую минуту |
| `напомни о встрече каждый час` | Уведомления о встрече каждый час |
| `Создай напоминание о новостях каждые 30 минут` | Технологические новости каждые 30 минут |
| `напоминай о спорте ежедневно` | Ежедневные уведомления о спорте |

### Как это работает?

```
┌─────────────────────────────────────────────────────────────┐
│                    ЗАПРОС ПОЛЬЗОВАТЕЛЯ                      │
├─────────────────────────────────────────────────────────────┤
│ User: Напоминай мне о погоде в Шерегеше каждое утро         │
└─────────────────────────────────────────────────────────────┘
                              │
                              ▼ РАСПОЗНАВАНИЕ
┌─────────────────────────────────────────────────────────────┤
│ Название: Погода в Шерегеше                                 │
│ Описание: погода в Шерегеше                                 │
│ Интервал: daily                                            │
└─────────────────────────────────────────────────────────────┘
                              │
                              ▼ СОЗДАНИЕ НАПОМИНАНИЯ
┌─────────────────────────────────────────────────────────────┤
│ ID: reminder_123456789                                      │
│ Следующее срабатывание: завтра 09:00                        │
└─────────────────────────────────────────────────────────────┘
                              │
                              ▼ СРАБАТЫВАНИЕ (завтра 09:00)
┌─────────────────────────────────────────────────────────────┤
│ 🔍 ЗАПРОС К MCP СЕРВЕРУ                                     │
│ get_weather(location: "Шерегеш")                            │
├─────────────────────────────────────────────────────────────┤
│ 📊 РЕАЛЬНЫЕ ДАННЫЕ ПОГОДЫ                                   │
│ Температура: +15°C                                          │
│ Осадки: нет                                                 │
│ Ветер: 3 м/с                                                │
└─────────────────────────────────────────────────────────────┘
                              │
                              ▼ ГЕНЕРАЦИЯ УВЕДОМЛЕНИЯ
┌─────────────────────────────────────────────────────────────┤
│ 🤖 ЗАПРОС К AI                                              │
│ "Создай уведомление о погоде на основе данных..."          │
├─────────────────────────────────────────────────────────────┤
│ 📨 УВЕДОМЛЕНИЕ В ЧАТ                                        │
│ 🔔 Погода в Шерегеше                                        │
│ ☀️ Сегодня солнечно, температура +15°C, слабый ветер...    │
└─────────────────────────────────────────────────────────────┘
```

### MCP интеграция для погоды

Для погодных напоминаний система пытается получить реальные данные через MCP инструменты:

1. Автоматическое распознавание запросов о погоде
2. Извлечение названия локации из текста
3. Вызов MCP инструмента `get_weather`, `weather` или аналогичного
4. Использование реальных данных в генерации уведомления

### API эндпоинты

```javascript
// Выполнение MCP инструмента
POST /api/mcp/execute
Body: { toolName: "get_weather", arguments: { location: "Шерегеш" } }

// Получение списка MCP инструментов
GET /api/mcp/tools
```

### Проверка работы из консоли браузера

```javascript
// Посмотреть активные напоминания
console.log(getActiveReminders());

// Создать тестовое напоминание
createReminder("Тест", "Тестовое напоминание", "hourly");

// Распознать запрос
console.log(parseReminderRequest("Напоминай о погоде в Москве"));

// Проверить напоминания немедленно (для тестирования)
checkRemindersNow();

// Показать отладочную информацию
showReminderDebug();

// Тестировать получение погоды
testMCPWeather('Шерегеш');

// Тестировать MCP инструмент напрямую
testMCPTool('get_weather', { city: 'Шерегеш' });

// Специальный тест для вашего MCP сервера
testWeatherCity('Bratsk');

// Тест извлечения города из текста
testCityExtraction('Напоминай о погоде в Шерегеше');

// Удалить все напоминания
clearAllReminders();

// Полная остановка всех процессов напоминаний
stopAllReminders();

// Принудительная очистка всех данных (включая localStorage)
forceClearAllReminderData();

// Проверка содержимого localStorage
inspectReminderStorage();

// Полное сканирование localStorage
scanAllLocalStorage();

// ПОЛНОЕ УНИЧТОЖЕНИЕ всех данных напоминаний (опасно!)
nukeAllReminders();

// Принудительное обновление UI напоминаний
forceUpdateRemindersUI();

// Создание тестового напоминания с проверкой UI
testCreateReminderUI('Тест', 'every-15-min');
```

---

## 🔗 MCP Chain Agent - Агент-оркестратор

### Что это такое?

MCP Chain Agent — это агент-оркестратор, который координирует работу нескольких MCP серверов в цепочку. Он реализует паттерн **"поиск → суммаризация → сохранение"**, где результат каждого шага передается в следующий.

### Архитектура

```
┌─────────────────────────────────────────────────────────────┐
│                      MCP CHAIN AGENT                        │
│                     (Оркестратор)                           │
└─────────────────────────────────────────────────────────────┘
                              │
                              ▼
┌─────────────────────────────────────────────────────────────┐
│  ШАГ 1: searchDocs                                          │
│  ├─ Поиск в документации по запросу                         │
│  └─ Возвращает релевантные результаты                       │
└─────────────────────────────────────────────────────────────┘
                              │
                              ▼
┌─────────────────────────────────────────────────────────────┐
│  ШАГ 2: summarize                                           │
│  ├─ Получает результаты поиска                              │
│  ├─ Создает краткое резюме                                  │
│  └─ Извлекает ключевые моменты                              │
└─────────────────────────────────────────────────────────────┘
                              │
                              ▼
┌─────────────────────────────────────────────────────────────┐
│  ШАГ 3: saveToFile                                          │
│  ├─ Получает резюме и полные результаты                     │
│  ├─ Форматирует итоговый документ                           │
│  └─ Сохраняет в файл (MD/TXT/JSON)                          │
└─────────────────────────────────────────────────────────────┘
                              │
                              ▼
                    Готовый файл с результатами
```

### Доступные MCP серверы

#### 1. searchDocs - Поиск в документации

**Описание:** Поиск информации в документации или базе знаний по запросу.

**Параметры:**
- `query` (обязательный) - Поисковый запрос
- `limit` (опциональный, по умолчанию 5) - Максимальное количество результатов
- `source` (опциональный, по умолчанию 'web') - Источник документации

**Пример:**
```javascript
{
  "query": "MCP архитектура",
  "limit": 5,
  "source": "web"
}
```

#### 2. summarize - Суммаризация текста

**Описание:** Создание краткого резюме из большого текста.

**Параметры:**
- `text` (обязательный) - Текст для суммаризации
- `maxLength` (опциональный, по умолчанию 200) - Максимальная длина резюме в словах
- `format` (опциональный, по умолчанию 'bullet-points') - Формат вывода:
  - `bullet-points` - Маркированный список
  - `paragraph` - Параграф
  - `structured` - Структурированное резюме

**Пример:**
```javascript
{
  "text": "Длинный текст для суммаризации...",
  "maxLength": 200,
  "format": "bullet-points"
}
```

#### 3. saveToFile - Сохранение в файл

**Описание:** Сохранение текстовых данных в файл.

**Параметры:**
- `content` (обязательный) - Содержимое для сохранения
- `filename` (обязательный) - Имя файла с расширением
- `format` (опциональный, по умолчанию 'txt') - Формат файла (txt, md, json)
- `append` (опциональный, по умолчанию false) - Добавить к существующему файлу

**Пример:**
```javascript
{
  "content": "Содержимое файла...",
  "filename": "results.md",
  "format": "md",
  "append": false
}
```

### Использование

#### Через веб-интерфейс

1. Откройте http://localhost:3000/mcp-demo
2. Введите поисковый запрос
3. Настройте параметры (количество результатов, формат резюме, формат файла)
4. Нажмите "▶️ Запустить цепочку"
5. Следите за прогрессом выполнения
6. Просматривайте сохранённые файлы

#### Через API

**Запуск полной цепочки:**

```bash
curl -X POST http://localhost:3000/api/mcp/chain \
  -H "Content-Type: application/json" \
  -d '{
    "query": "MCP архитектура и лучшие практики",
    "options": {
      "searchLimit": 5,
      "summaryFormat": "bullet-points",
      "summaryMaxLength": 200,
      "saveFormat": "md"
    }
  }'
```

**Выполнение отдельного инструмента:**

```bash
# Поиск
curl -X POST http://localhost:3000/api/mcp/tool \
  -H "Content-Type: application/json" \
  -d '{
    "toolName": "searchDocs",
    "args": {
      "query": "MCP security",
      "limit": 3
    }
  }'

# Суммаризация
curl -X POST http://localhost:3000/api/mcp/tool \
  -H "Content-Type: application/json" \
  -d '{
    "toolName": "summarize",
    "args": {
      "text": "Длинный текст...",
      "maxLength": 150,
      "format": "paragraph"
    }
  }'

# Сохранение
curl -X POST http://localhost:3000/api/mcp/tool \
  -H "Content-Type: application/json" \
  -d '{
    "toolName": "saveToFile",
    "args": {
      "content": "Содержимое...",
      "filename": "result.md",
      "format": "md"
    }
  }'
```

### API эндпоинты

| Метод | Путь | Описание |
|-------|------|----------|
| POST | `/api/mcp/chain` | Выполнить полную цепочку |
| POST | `/api/mcp/tool` | Выполнить отдельный инструмент |
| GET | `/api/mcp/agent-tools` | Получить список инструментов |
| GET | `/api/mcp/history` | Получить историю выполнений |
| GET | `/api/mcp/stats` | Получить статистику |
| GET | `/api/mcp/files` | Получить список файлов |
| GET | `/api/mcp/files/:filename` | Прочитать файл |

### Запуск примеров

#### Из командной строки:

```bash
# Запуск тестовых примеров
node mcp-agent.js
```

#### Из Node.js кода:

```javascript
const MCPAgent = require('./mcp-agent');

const agent = new MCPAgent();

// Запуск цепочки
await agent.executeChain('MCP архитектура', {
  searchLimit: 5,
  summaryFormat: 'bullet-points',
  saveFilename: 'mcp-architecture.md'
});

// Получение статистики
console.log(agent.getStats());

// Просмотр сохранённых файлов
const files = await agent.getSavedFiles();
console.log(files);
```

### Примеры использования

#### Пример 1: Исследование технологии

```javascript
await agent.executeChain('Node.js best practices 2024', {
  searchLimit: 5,
  summaryFormat: 'structured',
  summaryMaxLength: 300,
  saveFormat: 'md'
});
```

#### Пример 2: Сбор информации о безопасности

```javascript
await agent.executeChain('API security vulnerabilities', {
  searchLimit: 8,
  summaryFormat: 'bullet-points',
  summaryMaxLength: 250,
  saveFormat: 'md'
});
```

#### Пример 3: Анализ документации

```javascript
await agent.executeChain('GraphQL vs REST API comparison', {
  searchLimit: 6,
  summaryFormat: 'paragraph',
  summaryMaxLength: 200,
  saveFormat: 'txt'
});
```

### Структура сохранённых файлов

Все файлы сохраняются в директорию `mcp-output/` в корне проекта.

**Формат Markdown (.md):**

```markdown
---
Создано: 2024-12-19T10:30:00.000Z
Формат: Markdown
---

# Результаты поиска и анализа

**Запрос:** MCP архитектура
**Дата:** 19.12.2024, 13:30:00
**Найдено документов:** 5

---

## Краткое резюме

### Краткое резюме

• MCP (Model Context Protocol) — стандартизированный протокол для взаимодействия AI моделей
• Архитектура построена по принципу клиент-сервер
• Каждый сервер предоставляет набор инструментов через унифицированный API
...

---

## Детальные результаты поиска

### 1. Введение в MCP
...
```

### Статистика и мониторинг

```javascript
// Получение статистики
const stats = agent.getStats();
console.log(stats);
// {
//   totalExecutions: 10,
//   successfulExecutions: 9,
//   failedExecutions: 1,
//   successRate: '90.0%',
//   avgDuration: 1523
// }

// Получение истории
const history = agent.getExecutionHistory();
console.log(history);
// [
//   {
//     id: 'chain_1234567890',
//     query: 'MCP архитектура',
//     status: 'completed',
//     steps: [...],
//     totalDuration: 1523
//   }
// ]
```

### Отладка проблем

Если напоминания не приходят, проверьте:

1. **Консоль браузера** - откройте DevTools (F12) и посмотрите на сообщения
2. **Активные напоминания** - выполните `showReminderDebug()` в консоли
3. **Ручная проверка** - нажмите кнопку "🧪 Проверить сейчас" в настройках
4. **Интервал проверки** - система проверяет каждые 10 секунд

### Возможные проблемы и решения

| Проблема | Решение |
|----------|---------|
| Напоминания не приходят | Проверьте консоль, нажмите "🧪 Проверить сейчас" |
| Минутные напоминания не работают | Подтвердите создание, подождите 10-20 секунд |
| Ошибки в консоли | Проверьте подключение к MCP серверу (если используется погода) |
| Напоминания не сохраняются | Очистите localStorage или проверьте права браузера |
| MCP: "City parameter is required" | Система автоматически попробует разные параметры (city, location, query, place, name) |
| Погода не отображается в уведомлениях | Проверьте работу MCP сервера командой `testMCPWeather('город')` |
| Не вижу все напоминания | Обновите интерфейс или используйте `showReminderDebug()` |
| Хочу удалить все напоминания | Используйте кнопку "🗑️ Удалить все" или `clearAllReminders()` |
| Сервер продолжает запрашивать погоду без напоминаний | Используйте `stopAllReminders()` для полной остановки всех процессов |
| Есть напоминания в localStorage, но не видны в интерфейсе | Используйте `inspectReminderStorage()` для проверки, затем `forceClearAllReminderData()` |
| Есть старые/скрытые напоминания под другими ключами | Используйте `scanAllLocalStorage()` для поиска, затем `nukeAllReminders()` для полного удаления |
| Напоминания не отображаются в интерфейсе | Используйте `forceUpdateRemindersUI()` для принудительного обновления или `testCreateReminderUI()` для тестирования |